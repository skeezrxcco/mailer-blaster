name: Deploy On Main

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-main-${{ github.ref }}
  cancel-in-progress: false

jobs:
  checks:
    name: Run checks before deploy
    uses: ./.github/workflows/checks.yml

  build:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: checks
    timeout-minutes: 30
    outputs:
      image_tag: ${{ steps.vars.outputs.image_tag }}
      image_ref: ${{ steps.vars.outputs.image_ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set build vars
        id: vars
        run: |
          short_sha="${GITHUB_SHA::7}"
          image_tag="sha-${short_sha}"
          image_ref="skeezrxcco/mailerblaster:${image_tag}"
          echo "image_tag=${image_tag}" >> "$GITHUB_OUTPUT"
          echo "image_ref=${image_ref}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.prod
          push: true
          tags: |
            skeezrxcco/mailerblaster:latest
            ${{ steps.vars.outputs.image_ref }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      IMAGE_REF: ${{ needs.build.outputs.image_ref }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      AUTH_URL: ${{ secrets.AUTH_URL }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      AUTH_TRUST_HOST: ${{ secrets.AUTH_TRUST_HOST }}
      AUTH_EMAIL_FROM: ${{ secrets.AUTH_EMAIL_FROM }}
      AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
      AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}
      AUTH_GITHUB_ID: ${{ secrets.AUTH_GITHUB_ID }}
      AUTH_GITHUB_SECRET: ${{ secrets.AUTH_GITHUB_SECRET }}
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      REDIS_URL: ${{ secrets.REDIS_URL }}
      NATS_URL: ${{ secrets.NATS_URL }}
      AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
      AI_PROVIDER_PRIORITY: ${{ secrets.AI_PROVIDER_PRIORITY }}
      AI_PROVIDER_STRICT: ${{ secrets.AI_PROVIDER_STRICT }}
      AI_FREE_ONBOARDING_ENABLED: ${{ secrets.AI_FREE_ONBOARDING_ENABLED }}
      AI_FREE_ONBOARDING_PLANS: ${{ secrets.AI_FREE_ONBOARDING_PLANS }}
      AI_FREE_DAILY_OPENAI: ${{ secrets.AI_FREE_DAILY_OPENAI }}
      AI_FREE_DAILY_ANTHROPIC: ${{ secrets.AI_FREE_DAILY_ANTHROPIC }}
      AI_FREE_DAILY_DEEPSEEK: ${{ secrets.AI_FREE_DAILY_DEEPSEEK }}
      AI_FREE_DAILY_GROK: ${{ secrets.AI_FREE_DAILY_GROK }}
      AI_FREE_DAILY_LLAMA: ${{ secrets.AI_FREE_DAILY_LLAMA }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
      ANTHROPIC_MAX_TOKENS: ${{ secrets.ANTHROPIC_MAX_TOKENS }}
      DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
      GROK_BASE_URL: ${{ secrets.GROK_BASE_URL }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
      GROK_MODEL: ${{ secrets.GROK_MODEL }}
      LLAMA_BASE_URL: ${{ secrets.LLAMA_BASE_URL }}
      LLAMA_API_KEY: ${{ secrets.LLAMA_API_KEY }}
      LLAMA_MODEL: ${{ secrets.LLAMA_MODEL }}
      AUTH_CODE_TTL_MINUTES: ${{ secrets.AUTH_CODE_TTL_MINUTES }}
      AUTH_CODE_RESEND_COOLDOWN_SECONDS: ${{ secrets.AUTH_CODE_RESEND_COOLDOWN_SECONDS }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required deploy secrets
        run: |
          set -e
          missing=0
          for key in VPS_HOST VPS_USER VPS_SSH_KEY DOCKERHUB_USERNAME DOCKERHUB_TOKEN POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB AUTH_SECRET NEXTAUTH_SECRET AUTH_URL NEXTAUTH_URL AUTH_TRUST_HOST AUTH_EMAIL_FROM AUTH_GOOGLE_ID AUTH_GOOGLE_SECRET AUTH_GITHUB_ID AUTH_GITHUB_SECRET EMAIL_FROM SMTP_HOST SMTP_PORT SMTP_USER SMTP_PASS REDIS_URL NATS_URL AI_PROVIDER AUTH_CODE_TTL_MINUTES AUTH_CODE_RESEND_COOLDOWN_SECONDS; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required secret: $key"
              missing=1
            fi
          done
          if [ -z "${OPENAI_API_KEY}" ] && [ -z "${ANTHROPIC_API_KEY}" ] && [ -z "${DEEPSEEK_API_KEY}" ] && [ -z "${GROK_API_KEY}" ] && [ -z "${LLAMA_API_KEY}" ]; then
            echo "::error::At least one AI provider key is required (OPENAI_API_KEY, ANTHROPIC_API_KEY, DEEPSEEK_API_KEY, GROK_API_KEY, LLAMA_API_KEY)."
            missing=1
          fi
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.VPS_SSH_KEY }}

      - name: Add VPS host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

      - name: Prepare production env file
        run: |
          {
            printf 'NODE_ENV=production\n'
            printf 'DOCKERHUB_IMAGE=%s\n' "$IMAGE_REF"
            printf 'POSTGRES_USER=%s\n' "$POSTGRES_USER"
            printf 'POSTGRES_PASSWORD=%s\n' "$POSTGRES_PASSWORD"
            printf 'POSTGRES_DB=%s\n' "$POSTGRES_DB"
            printf 'DATABASE_URL=postgresql://%s:%s@db:5432/%s?schema=public\n' "$POSTGRES_USER" "$POSTGRES_PASSWORD" "$POSTGRES_DB"
            printf 'AUTH_SECRET=%s\n' "$AUTH_SECRET"
            printf 'NEXTAUTH_SECRET=%s\n' "$NEXTAUTH_SECRET"
            printf 'AUTH_URL=%s\n' "$AUTH_URL"
            printf 'NEXTAUTH_URL=%s\n' "$NEXTAUTH_URL"
            printf 'AUTH_TRUST_HOST=%s\n' "$AUTH_TRUST_HOST"
            printf 'AUTH_EMAIL_FROM=%s\n' "$AUTH_EMAIL_FROM"
            printf 'AUTH_GOOGLE_ID=%s\n' "$AUTH_GOOGLE_ID"
            printf 'AUTH_GOOGLE_SECRET=%s\n' "$AUTH_GOOGLE_SECRET"
            printf 'AUTH_GITHUB_ID=%s\n' "$AUTH_GITHUB_ID"
            printf 'AUTH_GITHUB_SECRET=%s\n' "$AUTH_GITHUB_SECRET"
            printf 'EMAIL_FROM=%s\n' "$EMAIL_FROM"
            printf 'SMTP_HOST=%s\n' "$SMTP_HOST"
            printf 'SMTP_PORT=%s\n' "$SMTP_PORT"
            printf 'SMTP_USER=%s\n' "$SMTP_USER"
            printf 'SMTP_PASS=%s\n' "$SMTP_PASS"
            printf 'REDIS_URL=%s\n' "$REDIS_URL"
            printf 'NATS_URL=%s\n' "$NATS_URL"
            printf 'AI_PROVIDER=%s\n' "$AI_PROVIDER"
            printf 'AI_PROVIDER_PRIORITY=%s\n' "${AI_PROVIDER_PRIORITY:-deepseek,llama,openai,anthropic,grok}"
            printf 'AI_PROVIDER_STRICT=%s\n' "${AI_PROVIDER_STRICT:-false}"
            printf 'AI_FREE_ONBOARDING_ENABLED=%s\n' "${AI_FREE_ONBOARDING_ENABLED:-true}"
            printf 'AI_FREE_ONBOARDING_PLANS=%s\n' "${AI_FREE_ONBOARDING_PLANS:-starter,free,trial}"
            printf 'AI_FREE_DAILY_OPENAI=%s\n' "${AI_FREE_DAILY_OPENAI:-0}"
            printf 'AI_FREE_DAILY_ANTHROPIC=%s\n' "${AI_FREE_DAILY_ANTHROPIC:-0}"
            printf 'AI_FREE_DAILY_DEEPSEEK=%s\n' "${AI_FREE_DAILY_DEEPSEEK:-0}"
            printf 'AI_FREE_DAILY_GROK=%s\n' "${AI_FREE_DAILY_GROK:-0}"
            printf 'AI_FREE_DAILY_LLAMA=%s\n' "${AI_FREE_DAILY_LLAMA:-0}"
            printf 'OPENAI_BASE_URL=%s\n' "${OPENAI_BASE_URL:-https://api.openai.com/v1}"
            printf 'OPENAI_API_KEY=%s\n' "$OPENAI_API_KEY"
            printf 'OPENAI_MODEL=%s\n' "${OPENAI_MODEL:-gpt-4.1-mini}"
            printf 'ANTHROPIC_BASE_URL=%s\n' "${ANTHROPIC_BASE_URL:-https://api.anthropic.com/v1}"
            printf 'ANTHROPIC_API_KEY=%s\n' "$ANTHROPIC_API_KEY"
            printf 'ANTHROPIC_MODEL=%s\n' "${ANTHROPIC_MODEL:-claude-3-5-haiku-latest}"
            printf 'ANTHROPIC_MAX_TOKENS=%s\n' "${ANTHROPIC_MAX_TOKENS:-1024}"
            printf 'DEEPSEEK_BASE_URL=%s\n' "${DEEPSEEK_BASE_URL:-https://api.deepseek.com/v1}"
            printf 'DEEPSEEK_API_KEY=%s\n' "$DEEPSEEK_API_KEY"
            printf 'DEEPSEEK_MODEL=%s\n' "${DEEPSEEK_MODEL:-deepseek-chat}"
            printf 'GROK_BASE_URL=%s\n' "${GROK_BASE_URL:-https://api.x.ai/v1}"
            printf 'GROK_API_KEY=%s\n' "$GROK_API_KEY"
            printf 'GROK_MODEL=%s\n' "${GROK_MODEL:-grok-beta}"
            printf 'LLAMA_BASE_URL=%s\n' "${LLAMA_BASE_URL:-https://api.llama.com/compat/v1}"
            printf 'LLAMA_API_KEY=%s\n' "$LLAMA_API_KEY"
            printf 'LLAMA_MODEL=%s\n' "${LLAMA_MODEL:-Llama-3.3-70B-Instruct}"
            printf 'AUTH_CODE_TTL_MINUTES=%s\n' "$AUTH_CODE_TTL_MINUTES"
            printf 'AUTH_CODE_RESEND_COOLDOWN_SECONDS=%s\n' "$AUTH_CODE_RESEND_COOLDOWN_SECONDS"
            printf 'STRIPE_SECRET_KEY=%s\n' "$STRIPE_SECRET_KEY"
            printf 'STRIPE_WEBHOOK_SECRET=%s\n' "$STRIPE_WEBHOOK_SECRET"
          } > .env.production

      - name: Upload compose and env to VPS
        run: |
          ssh "$VPS_USER@$VPS_HOST" "mkdir -p /opt/mailerblaster"
          scp docker-compose.prod.yml "$VPS_USER@$VPS_HOST:/opt/mailerblaster/docker-compose.prod.yml"
          scp .env.production "$VPS_USER@$VPS_HOST:/opt/mailerblaster/.env.production"

      - name: Deploy containers on VPS
        run: |
          ssh "$VPS_USER@$VPS_HOST" "
            set -e
            cd /opt/mailerblaster
            echo '$DOCKERHUB_TOKEN' | docker login -u '$DOCKERHUB_USERNAME' --password-stdin
            docker compose -f docker-compose.prod.yml --env-file .env.production pull
            docker compose -f docker-compose.prod.yml --env-file .env.production up -d --remove-orphans
            docker compose -f docker-compose.prod.yml --env-file .env.production ps
          "

      - name: Prune unused Docker resources on VPS
        run: |
          ssh "$VPS_USER@$VPS_HOST" "
            set -e
            docker container prune -f
            docker image prune -af
            docker volume prune -f
            docker network prune -f
            docker builder prune -af
          "

      - name: Deployment summary
        run: |
          {
            echo '### VPS deployment completed'
            echo "- Branch: \`${{ github.ref_name }}\`"
            echo "- Image: \`${IMAGE_REF}\`"
            echo "- Server: \`${VPS_HOST}\`"
          } >> "$GITHUB_STEP_SUMMARY"
